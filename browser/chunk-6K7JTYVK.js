import{b as d}from"./chunk-TQC3L4XM.js";import{a as _}from"./chunk-PTJ4CXVK.js";var s=class f{constructor(e,t,r,i,n=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||n,this._dynamic=r,this._name=i??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){let r=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;let i=this._uniformLocationPointer-r;for(let n=0;n<i;n++)this._data.push(0)}}addUniform(e,t,r=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let i;if(r>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:r},t==16)t=t*r;else{let u=(4-t)*r;t=t*r+u}i=[];for(let n=0;n<t;n++)i.push(0)}else{if(t instanceof Array)i=t,t=i.length;else{i=[];for(let n=0;n<t;n++)i.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let n=0;n<t;n++)this._data.push(i[n]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,r){let i=[t,r];this.addUniform(e,i)}addFloat3(e,t,r,i){let n=[t,r,i];this.addUniform(e,n)}addColor3(e,t){let r=[t.r,t.g,t.b];this.addUniform(e,r)}addColor4(e,t,r){let i=[t.r,t.g,t.b,r];this.addUniform(e,i)}addVector3(e,t){let r=[t.x,t.y,t.z];this.addUniform(e,r)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNames(){let e=[],t=0;for(let r in this._uniformLocations)if(e.push(r),++t===10)break;return e.join(",")}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._engine._features.trackUbosInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0}_copyBuffer(e,t){for(let r=0;r<e.length;++r)t[r]=e[r]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(f._UpdatedUbosInFrame[this._name]||(f._UpdatedUbosInFrame[this._name]=0),f._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,r){this._checkNewFrame();let i=this._uniformLocations[e];if(i===void 0){if(this._buffer){_.Error("Cannot add an uniform after UBO has been created. uniformName="+e);return}this.addUniform(e,r),i=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let n=0;n<r;n++)this._bufferData[i+n]=t[n];else{let n=!1;for(let u=0;u<r;u++)(r===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[i+u]!==Math.fround(t[u]))&&(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[i+u]=t[u]);this._needSync=this._needSync||n}}updateUniformArray(e,t,r){this._checkNewFrame();let i=this._uniformLocations[e];if(i===void 0){_.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();let n=this._uniformArraySizes[e];if(this._dynamic)for(let u=0;u<r;u++)this._bufferData[i+u]=t[u];else{let u=!1,a=0,o=0;for(let h=0;h<r;h++)if(this._bufferData[i+o*4+a]!==d.FloatRound(t[h])&&(u=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[i+o*4+a]=t[h]),a++,a===n.strideSize){for(;a<4;a++)this._bufferData[i+o*4+a]=0;a=0,o++}this._needSync=this._needSync||u}}_cacheMatrix(e,t){this._checkNewFrame();let r=this._valueCache[e],i=t.updateFlag;return r!==void 0&&r===i?!1:(this._valueCache[e]=i,!0)}_updateMatrix3x3ForUniform(e,t){for(let r=0;r<3;r++)f._TempBuffer[r*4]=t[r*3],f._TempBuffer[r*4+1]=t[r*3+1],f._TempBuffer[r*4+2]=t[r*3+2],f._TempBuffer[r*4+3]=0;this.updateUniform(e,f._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let r=0;r<2;r++)f._TempBuffer[r*4]=t[r*2],f._TempBuffer[r*4+1]=t[r*2+1],f._TempBuffer[r*4+2]=0,f._TempBuffer[r*4+3]=0;this.updateUniform(e,f._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){f._TempBuffer[0]=t,this.updateUniform(e,f._TempBuffer,1)}_updateFloat2ForEffect(e,t,r,i=""){this._currentEffect.setFloat2(e+i,t,r)}_updateFloat2ForUniform(e,t,r){f._TempBuffer[0]=t,f._TempBuffer[1]=r,this.updateUniform(e,f._TempBuffer,2)}_updateFloat3ForEffect(e,t,r,i,n=""){this._currentEffect.setFloat3(e+n,t,r,i)}_updateFloat3ForUniform(e,t,r,i){f._TempBuffer[0]=t,f._TempBuffer[1]=r,f._TempBuffer[2]=i,this.updateUniform(e,f._TempBuffer,3)}_updateFloat4ForEffect(e,t,r,i,n,u=""){this._currentEffect.setFloat4(e+u,t,r,i,n)}_updateFloat4ForUniform(e,t,r,i,n){f._TempBuffer[0]=t,f._TempBuffer[1]=r,f._TempBuffer[2]=i,f._TempBuffer[3]=n,this.updateUniform(e,f._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){f._TempBufferInt32View.set(t),this.updateUniformArray(e,f._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){f._TempBufferUInt32View.set(t),this.updateUniformArray(e,f._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){f._TempBuffer[0]=t.x,f._TempBuffer[1]=t.y,f._TempBuffer[2]=t.z,this.updateUniform(e,f._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){f._TempBuffer[0]=t.x,f._TempBuffer[1]=t.y,f._TempBuffer[2]=t.z,f._TempBuffer[3]=t.w,this.updateUniform(e,f._TempBuffer,4)}_updateColor3ForEffect(e,t,r=""){this._currentEffect.setColor3(e+r,t)}_updateColor3ForUniform(e,t){f._TempBuffer[0]=t.r,f._TempBuffer[1]=t.g,f._TempBuffer[2]=t.b,this.updateUniform(e,f._TempBuffer,3)}_updateColor4ForEffect(e,t,r,i=""){this._currentEffect.setColor4(e+i,t,r)}_updateDirectColor4ForEffect(e,t,r=""){this._currentEffect.setDirectColor4(e+r,t)}_updateColor4ForUniform(e,t,r){f._TempBuffer[0]=t.r,f._TempBuffer[1]=t.g,f._TempBuffer[2]=t.b,f._TempBuffer[3]=r,this.updateUniform(e,f._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){f._TempBuffer[0]=t.r,f._TempBuffer[1]=t.g,f._TempBuffer[2]=t.b,f._TempBuffer[3]=t.a,this.updateUniform(e,f._TempBuffer,4)}_updateIntForEffect(e,t,r=""){this._currentEffect.setInt(e+r,t)}_updateIntForUniform(e,t){f._TempBufferInt32View[0]=t,this.updateUniform(e,f._TempBuffer,1)}_updateInt2ForEffect(e,t,r,i=""){this._currentEffect.setInt2(e+i,t,r)}_updateInt2ForUniform(e,t,r){f._TempBufferInt32View[0]=t,f._TempBufferInt32View[1]=r,this.updateUniform(e,f._TempBuffer,2)}_updateInt3ForEffect(e,t,r,i,n=""){this._currentEffect.setInt3(e+n,t,r,i)}_updateInt3ForUniform(e,t,r,i){f._TempBufferInt32View[0]=t,f._TempBufferInt32View[1]=r,f._TempBufferInt32View[2]=i,this.updateUniform(e,f._TempBuffer,3)}_updateInt4ForEffect(e,t,r,i,n,u=""){this._currentEffect.setInt4(e+u,t,r,i,n)}_updateInt4ForUniform(e,t,r,i,n){f._TempBufferInt32View[0]=t,f._TempBufferInt32View[1]=r,f._TempBufferInt32View[2]=i,f._TempBufferInt32View[3]=n,this.updateUniform(e,f._TempBuffer,4)}_updateUIntForEffect(e,t,r=""){this._currentEffect.setUInt(e+r,t)}_updateUIntForUniform(e,t){f._TempBufferUInt32View[0]=t,this.updateUniform(e,f._TempBuffer,1)}_updateUInt2ForEffect(e,t,r,i=""){this._currentEffect.setUInt2(e+i,t,r)}_updateUInt2ForUniform(e,t,r){f._TempBufferUInt32View[0]=t,f._TempBufferUInt32View[1]=r,this.updateUniform(e,f._TempBuffer,2)}_updateUInt3ForEffect(e,t,r,i,n=""){this._currentEffect.setUInt3(e+n,t,r,i)}_updateUInt3ForUniform(e,t,r,i){f._TempBufferUInt32View[0]=t,f._TempBufferUInt32View[1]=r,f._TempBufferUInt32View[2]=i,this.updateUniform(e,f._TempBuffer,3)}_updateUInt4ForEffect(e,t,r,i,n,u=""){this._currentEffect.setUInt4(e+u,t,r,i,n)}_updateUInt4ForUniform(e,t,r,i,n){f._TempBufferUInt32View[0]=t,f._TempBufferUInt32View[1]=r,f._TempBufferUInt32View[2]=i,f._TempBufferUInt32View[3]=n,this.updateUniform(e,f._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,this._buffers.length>1&&this._buffers[t][1]&&this._bufferData.set(this._buffers[t][1]),this._valueCache={},this._currentFrameId=this._engine.frameId,!0;return!1}dispose(){if(this._noUBO)return;let e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let r=0;r<this._buffers.length;++r){let i=this._buffers[r][0];this._engine._releaseBuffer(i)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}};s._UpdatedUbosInFrame={};s._MAX_UNIFORM_SIZE=256;s._TempBuffer=new Float32Array(s._MAX_UNIFORM_SIZE);s._TempBufferInt32View=new Int32Array(s._TempBuffer.buffer);s._TempBufferUInt32View=new Uint32Array(s._TempBuffer.buffer);var U=(()=>{class f{static get UniqueId(){let t=this._UniqueIdCounter;return this._UniqueIdCounter++,t}}return f._UniqueIdCounter=1,f})();export{s as a,U as b};
