import{c as V,d as W,g as F,w as k}from"./chunk-ASQBT7SM.js";import{b as R}from"./chunk-URH3WTQF.js";import{h as g}from"./chunk-VE22RIJ6.js";import{b as j}from"./chunk-TQC3L4XM.js";import{i as G}from"./chunk-HFWKE5SR.js";import{C as I}from"./chunk-P7VVLCEC.js";import{a as H}from"./chunk-PTJ4CXVK.js";import{a as U,b as O,g as T}from"./chunk-GON3DZPO.js";var B=class{static ExpandRGBDTexture(r){let t=r._texture;if(!t||!r.isRGBD)return;let a=t.getEngine(),s=a.getCaps(),o=t.isReady,i=!1;s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(i=!0,t.type=2):s.textureFloatRender&&s.textureFloatLinearFiltering&&(i=!0,t.type=1),i&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);let l=()=>T(null,null,function*(){let n=a.isWebGPU,u=n?1:0;t.isReady=!1,n?yield import("./chunk-23MZ666J.js"):yield import("./chunk-UQDMZJ24.js");let c=new F("rgbdDecode","rgbdDecode",null,null,1,null,3,a,!1,void 0,t.type,void 0,null,!1,void 0,u);c.externalTextureSamplerBinding=!0;let d=a.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});c.onEffectCreatedObservable.addOnce(m=>{m.executeWhenCompiled(()=>{c.onApply=p=>{p._bindTexture("textureSampler",t),p.setFloat2("scale",1,1)},r.getScene().postProcessManager.directRender([c],d,!0),a.restoreDefaultFramebuffer(),a._releaseTexture(t),c&&c.dispose(),d._swapAndDie(t),t.isReady=!0})})});i&&(o?l():r.onLoadObservable.addOnce(l))}static EncodeTextureToRGBD(r,t,a=0){return T(this,null,function*(){return t.getEngine().isWebGPU?yield import("./chunk-W7VYN54Q.js"):yield import("./chunk-IDKPR23L.js"),yield k("rgbdEncode",r,t,a,1,5)})}};R.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(R.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=W.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});var S="image/png",Y=2,$=[134,22,135,150,246,214,150,54];function J(e){let r=new DataView(e.buffer,e.byteOffset,e.byteLength),t=0;for(let i=0;i<$.length;i++)if(r.getUint8(t++)!==$[i])return H.Error("Not a babylon environment map"),null;let a="",s=0;for(;s=r.getUint8(t++);)a+=String.fromCharCode(s);let o=JSON.parse(a);return o=D(o),o.binaryDataPosition=t,o.specular&&(o.specular.lodGenerationScale=o.specular.lodGenerationScale||.8),o}function D(e){if(e.version>Y)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${Y}".`);return e.version===2||(e=O(U({},e),{version:2,imageType:S})),e}function Z(e,r){r=D(r);let t=r.specular,a=Math.log2(r.width);if(a=Math.round(a)+1,t.mipmaps.length!==6*a)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);let s=new Array(a);for(let o=0;o<a;o++){s[o]=new Array(6);for(let i=0;i<6;i++){let l=t.mipmaps[o*6+i];s[o][i]=new Uint8Array(e.buffer,e.byteOffset+r.binaryDataPosition+l.position,l.length)}}return s}function ee(e,r){r=D(r);let t=new Array(6),a=r.irradiance?.irradianceTexture;if(a){if(a.faces.length!==6)throw new Error(`Incorrect irradiance texture faces number "${a.faces.length}"`);for(let s=0;s<6;s++){let o=a.faces[s];t[s]=new Uint8Array(e.buffer,e.byteOffset+r.binaryDataPosition+o.position,o.length)}}return t}function Q(e,r,t){t=D(t);let a=t.specular;if(!a)return Promise.resolve([]);e._lodGenerationScale=a.lodGenerationScale;let s=[],o=Z(r,t);s.push(te(e,o,t.imageType));let i=t.irradiance?.irradianceTexture;if(i){let l=ee(r,t);s.push(re(e,l,i.size,t.imageType))}return Promise.all(s)}function N(e,r,t,a,s,o,i,l,n,u,c){return T(this,null,function*(){return yield new Promise((d,m)=>{if(t){let p=r.createTexture(null,!0,!0,null,1,null,x=>{m(x)},e);a?.onEffectCreatedObservable.addOnce(x=>{x.executeWhenCompiled(()=>{a.externalTextureSamplerBinding=!0,a.onApply=A=>{A._bindTexture("textureSampler",p),A.setFloat2("scale",1,r._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},r.scenes.length&&(r.scenes[0].postProcessManager.directRender([a],u,!0,o,i),r.restoreDefaultFramebuffer(),p.dispose(),URL.revokeObjectURL(s),d())})})}else{if(r._uploadImageToTexture(c,e,o,i),l){let p=n[i];p&&r._uploadImageToTexture(p._texture,e,o,0)}d()}})})}function te(a,s){return T(this,arguments,function*(e,r,t=S){let o=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,o.updateTextureSamplingMode(3,e),yield q(e,r,!0,t),e.isReady=!0})}function re(s,o,i){return T(this,arguments,function*(e,r,t,a=S){let l=e.getEngine(),n=new I(l,5),u=new R(l,n);e._irradianceTexture=u,n.isCube=!0,n.format=5,n.type=0,n.generateMipMaps=!0,n._cachedAnisotropicFilteringLevel=null,n.generateMipMaps=!0,n.width=t,n.height=t,l.updateTextureSamplingMode(3,n),yield q(n,[r],!1,a),l.generateMipMapsForCubemap(n),n.isReady=!0})}function q(s,o,i){return T(this,arguments,function*(e,r,t,a=S){if(!j.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");let l=G(e.width)+1,n=e.getEngine(),u=!1,c=!1,d=null,m=null,p=null,x=n.getCaps();x.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?x.textureHalfFloatRender&&x.textureHalfFloatLinearFiltering?(u=!0,e.type=2):x.textureFloatRender&&x.textureFloatLinearFiltering&&(u=!0,e.type=1):u=!1:(u=!1,c=t);let A=0;if(u)n.isWebGPU?(A=1,yield import("./chunk-23MZ666J.js")):yield import("./chunk-UQDMZJ24.js"),d=new F("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,e.type,void 0,null,!1,void 0,A),e._isRGBD=!1,e.invertY=!1,m=n.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,c){p={};let h=e._lodGenerationScale,_=e._lodGenerationOffset;for(let y=0;y<3;y++){let v=1-y/2,w=_,M=(l-1)*h+_,C=w+(M-w)*v,z=Math.round(Math.min(Math.max(C,0),M)),L=new I(n,2);L.isCube=!0,L.invertY=!0,L.generateMipMaps=!1,n.updateTextureSamplingMode(2,L);let P=new R(null);switch(P._isCube=!0,P._texture=L,p[z]=P,y){case 0:e._lodTextureLow=P;break;case 1:e._lodTextureMid=P;break;case 2:e._lodTextureHigh=P;break}}}let E=[];for(let f=0;f<r.length;f++)for(let h=0;h<6;h++){let _=r[f][h],y=new Blob([_],{type:a}),b=URL.createObjectURL(y),v;if(n._features.forceBitmapOverHTMLImageElement)v=n.createImageBitmap(y,{premultiplyAlpha:"none"}).then(w=>T(null,null,function*(){return yield N(w,n,u,d,b,h,f,c,p,m,e)}));else{let w=new Image;w.src=b,v=new Promise((M,C)=>{w.onload=()=>{N(w,n,u,d,b,h,f,c,p,m,e).then(()=>M()).catch(z=>{C(z)})},w.onerror=z=>{C(z)}})}E.push(v)}if(yield Promise.all(E),r.length<l){let f,h=Math.pow(2,l-1-r.length),_=h*h*4;switch(e.type){case 0:{f=new Uint8Array(_);break}case 2:{f=new Uint16Array(_);break}case 1:{f=new Float32Array(_);break}}for(let y=r.length;y<l;y++)for(let b=0;b<6;b++)n._uploadArrayBufferViewToTexture(m?.texture||e,f,b,y)}if(m){let f=e._irradianceTexture;e._irradianceTexture=null,n._releaseTexture(e),m._swapAndDie(e),e._irradianceTexture=f}d&&d.dispose(),c&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))})}function K(e,r){r=D(r);let t=r.irradiance;if(!t)return;let a=new V;g.FromArrayToRef(t.x,0,a.x),g.FromArrayToRef(t.y,0,a.y),g.FromArrayToRef(t.z,0,a.z),g.FromArrayToRef(t.xx,0,a.xx),g.FromArrayToRef(t.yy,0,a.yy),g.FromArrayToRef(t.zz,0,a.zz),g.FromArrayToRef(t.yz,0,a.yz),g.FromArrayToRef(t.zx,0,a.zx),g.FromArrayToRef(t.xy,0,a.xy),e._sphericalPolynomial=a}var X=class{constructor(){this.supportCascades=!1}loadCubeData(r,t,a,s,o){if(Array.isArray(r))return;let i=J(r);if(i){t.width=i.width,t.height=i.width;try{K(t,i),Q(t,r,i).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()},l=>{o?.("Can not upload environment levels",l)})}catch(l){o?.("Can not upload environment file",l)}}else o&&o("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}};export{B as a,J as b,Z as c,K as d,X as e};
