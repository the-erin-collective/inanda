import{a as R}from"./chunk-GLDMC2Z5.js";import{h as S}from"./chunk-RMITEGV7.js";import{f}from"./chunk-C4D4KATR.js";import{b as m}from"./chunk-4UCLQGBG.js";var b=class r{static GetPlanes(s){let e=[];for(let t=0;t<6;t++)e.push(new R(0,0,0,0));return r.GetPlanesToRef(s,e),e}static GetNearPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]+t[2],e.normal.y=t[7]+t[6],e.normal.z=t[11]+t[10],e.d=t[15]+t[14],e.normalize()}static GetFarPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]-t[2],e.normal.y=t[7]-t[6],e.normal.z=t[11]-t[10],e.d=t[15]-t[14],e.normalize()}static GetLeftPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]+t[0],e.normal.y=t[7]+t[4],e.normal.z=t[11]+t[8],e.d=t[15]+t[12],e.normalize()}static GetRightPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]-t[0],e.normal.y=t[7]-t[4],e.normal.z=t[11]-t[8],e.d=t[15]-t[12],e.normalize()}static GetTopPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]-t[1],e.normal.y=t[7]-t[5],e.normal.z=t[11]-t[9],e.d=t[15]-t[13],e.normalize()}static GetBottomPlaneToRef(s,e){let t=s.m;e.normal.x=t[3]+t[1],e.normal.y=t[7]+t[5],e.normal.z=t[11]+t[9],e.d=t[15]+t[13],e.normalize()}static GetPlanesToRef(s,e){r.GetNearPlaneToRef(s,e[0]),r.GetFarPlaneToRef(s,e[1]),r.GetLeftPlaneToRef(s,e[2]),r.GetRightPlaneToRef(s,e[3]),r.GetTopPlaneToRef(s,e[4]),r.GetBottomPlaneToRef(s,e[5])}static IsPointInFrustum(s,e){for(let t=0;t<6;t++)if(e[t].dotCoordinate(s)<0)return!1;return!0}};var C=class{constructor(s){this._vertexBuffers={},this.onBeforeRenderObservable=new m,this._scene=s}_prepareBuffers(){if(this._vertexBuffers[f.PositionKind])return;let s=[];s.push(1,1),s.push(-1,1),s.push(-1,-1),s.push(1,-1),this._vertexBuffers[f.PositionKind]=new f(this._scene.getEngine(),s,f.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){let s=[];s.push(0),s.push(1),s.push(2),s.push(0),s.push(2),s.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(s)}_rebuild(){let s=this._vertexBuffers[f.PositionKind];s&&(s._rebuild(),this._buildIndexBuffer())}_prepareFrame(s=null,e=null){let t=this._scene.activeCamera;return!t||(e=e||t._postProcesses.filter(n=>n!=null),!e||e.length===0||!this._scene.postProcessesEnabled)?!1:(e[0].activate(t,s,e!=null),!0)}directRender(s,e=null,t=!1,n=0,a=0,h=!1,i=s.length){let o=this._scene.getEngine();for(let l=0;l<i;l++){l<s.length-1?s[l+1].activate(this._scene.activeCamera||this._scene,e?.texture):(e?o.bindFramebuffer(e,n,void 0,void 0,t,a):h||o.restoreDefaultFramebuffer(),o._debugInsertMarker?.(`post process ${s[l].name} output`));let p=s[l],d=p.apply();d&&(p.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,d),o.drawElementsType(0,0,6),p.onAfterRenderObservable.notifyObservers(d))}o.setDepthBuffer(!0),o.setDepthWrite(!0)}_finalizeFrame(s,e,t,n,a=!1){let h=this._scene.activeCamera;if(!h||(this.onBeforeRenderObservable.notifyObservers(this),n=n||h._postProcesses.filter(o=>o!=null),n.length===0||!this._scene.postProcessesEnabled))return;let i=this._scene.getEngine();for(let o=0,l=n.length;o<l;o++){let p=n[o];if(o<l-1?p._outputTexture=n[o+1].activate(h,e?.texture):(e?(i.bindFramebuffer(e,t,void 0,void 0,a),p._outputTexture=e):(i.restoreDefaultFramebuffer(),p._outputTexture=null),i._debugInsertMarker?.(`post process ${n[o].name} output`)),s)break;let d=p.apply();d&&(p.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),i.bindBuffers(this._vertexBuffers,this._indexBuffer,d),i.drawElementsType(0,0,6),p.onAfterRenderObservable.notifyObservers(d))}i.setDepthBuffer(!0),i.setDepthWrite(!0),i.setAlphaMode(0)}dispose(){let s=this._vertexBuffers[f.PositionKind];s&&(s.dispose(),this._vertexBuffers[f.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}};var c=(()=>{class r{constructor(e){this.length=0,this.data=new Array(e),this._id=r._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){let t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}}return r._GlobalId=0,r})(),_=class extends c{constructor(){super(...arguments),this._duplicateId=0}push(s){super.push(s),s.__smartArrayFlags||(s.__smartArrayFlags={}),s.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(s){return s.__smartArrayFlags&&s.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(s),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(s){if(s.length!==0){this.length+s.length>this.data.length&&(this.data.length=(this.length+s.length)*2);for(let e=0;e<s.length;e++){let t=(s.data||s)[e];this.pushNoDuplicate(t)}}}};var u=class r{set opaqueSortCompareFn(s){s?this._opaqueSortCompareFn=s:this._opaqueSortCompareFn=r.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(s){s?this._alphaTestSortCompareFn=s:this._alphaTestSortCompareFn=r.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(s){s?this._transparentSortCompareFn=s:this._transparentSortCompareFn=r.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(s,e,t=null,n=null,a=null){this.index=s,this._opaqueSubMeshes=new c(256),this._transparentSubMeshes=new c(256),this._alphaTestSubMeshes=new c(256),this._depthOnlySubMeshes=new c(256),this._particleSystems=new c(256),this._spriteManagers=new c(256),this._empty=!0,this._edgesRenderers=new _(16),this._scene=e,this.opaqueSortCompareFn=t,this.alphaTestSortCompareFn=n,this.transparentSortCompareFn=a}render(s,e,t,n){if(s){s(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}let a=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(a.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),a.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);let h=a.getStencilBuffer();if(a.setStencilBuffer(!1),e&&this._renderSprites(),t&&this._renderParticles(n),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(a.setStencilBuffer(h),this._scene.useOrderIndependentTransparency){let i=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);i.length&&this._renderTransparent(i)}else this._renderTransparent(this._transparentSubMeshes);a.setAlphaMode(0)}if(a.setStencilBuffer(!1),this._edgesRenderers.length){for(let i=0;i<this._edgesRenderers.length;i++)this._edgesRenderers.data[i].render();a.setAlphaMode(0)}a.setStencilBuffer(h)}_renderOpaqueSorted(s){r._RenderSorted(s,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(s){r._RenderSorted(s,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(s){r._RenderSorted(s,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(s,e,t,n){let a=0,h,i=t?t.globalPosition:r._ZeroVector;if(n)for(;a<s.length;a++)h=s.data[a],h._alphaIndex=h.getMesh().alphaIndex,h._distanceToCamera=S.Distance(h.getBoundingInfo().boundingSphere.centerWorld,i);let o=s.length===s.data.length?s.data:s.data.slice(0,s.length);e&&o.sort(e);let l=o[0].getMesh().getScene();for(a=0;a<o.length;a++)if(h=o[a],!(l._activeMeshesFrozenButKeepClipping&&!h.isInFrustum(l._frustumPlanes))){if(n){let p=h.getMaterial();if(p&&p.needDepthPrePass){let d=p.getScene().getEngine();d.setColorWrite(!1),d.setAlphaMode(0),h.render(!1),d.setColorWrite(!0)}}h.render(n)}}static defaultTransparentSortCompare(s,e){return s._alphaIndex>e._alphaIndex?1:s._alphaIndex<e._alphaIndex?-1:r.backToFrontSortCompare(s,e)}static backToFrontSortCompare(s,e){return s._distanceToCamera<e._distanceToCamera?1:s._distanceToCamera>e._distanceToCamera?-1:0}static frontToBackSortCompare(s,e){return s._distanceToCamera<e._distanceToCamera?-1:s._distanceToCamera>e._distanceToCamera?1:0}static PainterSortCompare(s,e){let t=s.getMesh(),n=e.getMesh();return t.material&&n.material?t.material.uniqueId-n.material.uniqueId:t.uniqueId-n.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(s,e,t){e===void 0&&(e=s.getMesh()),t===void 0&&(t=s.getMaterial()),t!=null&&(t.needAlphaBlendingForMesh(e)?this._transparentSubMeshes.push(s):t.needAlphaTestingForMesh(e)?(t.needDepthPrePass&&this._depthOnlySubMeshes.push(s),this._alphaTestSubMeshes.push(s)):(t.needDepthPrePass&&this._depthOnlySubMeshes.push(s),this._opaqueSubMeshes.push(s)),e._renderingGroup=this,e._edgesRenderer&&e.isEnabled()&&e.isVisible&&e._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(e._edgesRenderer),this._empty=!1)}dispatchSprites(s){this._spriteManagers.push(s),this._empty=!1}dispatchParticles(s){this._particleSystems.push(s),this._empty=!1}_renderParticles(s){if(this._particleSystems.length===0)return;let e=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._particleSystems.length;t++){let n=this._particleSystems.data[t];if((e&&e.layerMask&n.layerMask)===0)continue;let a=n.emitter;(!a.position||!s||s.indexOf(a)!==-1)&&this._scene._activeParticles.addCount(n.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;let s=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let e=0;e<this._spriteManagers.length;e++){let t=this._spriteManagers.data[e];(s&&s.layerMask&t.layerMask)!==0&&t.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}};u._ZeroVector=S.Zero();var g=class{},I=(()=>{class r{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(let e of this._scene.meshes)if(e.subMeshes)for(let t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(let e of this._scene.spriteManagers)e._wasDispatched=!1;for(let e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new g,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=r.MIN_RENDERINGGROUPS;t<r.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){let t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,n,a){let h=this._renderingGroupInfo;if(h.scene=this._scene,h.camera=this._scene.activeCamera,h.renderingManager=this,this._scene.spriteManagers&&a)for(let i=0;i<this._scene.spriteManagers.length;i++){let o=this._scene.spriteManagers[i];this.dispatchSprites(o)}for(let i=r.MIN_RENDERINGGROUPS;i<r.MAX_RENDERINGGROUPS;i++){this._depthStencilBufferAlreadyCleaned=i===r.MIN_RENDERINGGROUPS;let o=this._renderingGroups[i];if(!o||o._empty)continue;let l=1<<i;if(h.renderingGroupId=i,this._scene.onBeforeRenderingGroupObservable.notifyObservers(h,l),r.AUTOCLEAR){let p=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(i):this._autoClearDepthStencil[i];p&&p.autoClear&&this._clearDepthStencilBuffer(p.depth,p.stencil)}for(let p of this._scene._beforeRenderingGroupDrawStage)p.action(i);o.render(e,a,n,t);for(let p of this._scene._afterRenderingGroupDrawStage)p.action(i);this._scene.onAfterRenderingGroupObservable.notifyObservers(h,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=r.MIN_RENDERINGGROUPS;e<r.MAX_RENDERINGGROUPS;e++){let t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=r.MIN_RENDERINGGROUPS;e<r.MAX_RENDERINGGROUPS;e++){let t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=r.MIN_RENDERINGGROUPS;e<r.MAX_RENDERINGGROUPS;e++){let t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new u(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,n){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,n))}setRenderingOrder(e,t=null,n=null,a=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=n,this._customTransparentSortCompareFn[e]=a,this._renderingGroups[e]){let h=this._renderingGroups[e];h.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],h.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],h.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,n=!0,a=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:n,stencil:a}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}return r.MAX_RENDERINGGROUPS=4,r.MIN_RENDERINGGROUPS=0,r.AUTOCLEAR=!0,r})();export{b as a,C as b,c,_ as d,I as e};
