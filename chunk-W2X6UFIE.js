import{a as j}from"./chunk-QG7TSJPJ.js";import{b as Q,c as K,d as U,e as z,f as Y,g as H,h as q,i as f}from"./chunk-7D4FEIWU.js";import{d as S,f as I,g as J}from"./chunk-XK53KQBE.js";import{l as X}from"./chunk-ETRKVN42.js";import{a as V}from"./chunk-E776PK6J.js";import{e as E,h as M,j as T,k as A,l as x}from"./chunk-RMITEGV7.js";import{a as W}from"./chunk-3WG2WLZ4.js";import{e as Z}from"./chunk-CWQQB2EJ.js";import{b as G}from"./chunk-65CEQG3Z.js";import{b as O}from"./chunk-4UCLQGBG.js";import{j as N}from"./chunk-RLBU4MYZ.js";var P=class l extends Q{get _matrix(){return this._compose(),this._localMatrix}set _matrix(t){t.updateFlag===this._localMatrix.updateFlag&&!this._needToCompose||(this._needToCompose=!1,this._localMatrix.copyFrom(t),this._markAsDirtyAndDecompose())}constructor(t,e,i=null,n=null,s=null,a=null,o=null){super(t,e.getScene(),!1),this.name=t,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=e,this._localMatrix=n?.clone()??A.Identity(),this._restMatrix=s??this._localMatrix.clone(),this._bindMatrix=a??this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new A,this._absoluteBindMatrix=new A,this._absoluteInverseBindMatrix=new A,this._finalMatrix=new A,e.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(t){this.setParent(t)}setParent(t,e=!0){if(this.parent!==t){if(this.parent){let i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=t,this.parent&&this.parent.children.push(this),e&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(t){this._restMatrix.copyFrom(t)}setRestPose(t){this.setRestMatrix(t)}getBindPose(){return this.getBindMatrix()}setBindMatrix(t){this.updateMatrix(t)}setBindPose(t){this.setBindMatrix(t)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){let t=x.Vector3[0],e=x.Quaternion[0],i=x.Vector3[1];this.getRestMatrix().decompose(t,e,i),this._linkedTransformNode.position.copyFrom(i),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??T.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(e),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(t){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=t,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(t){this._decompose(),this._localPosition.copyFrom(t),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(t){this.setRotation(t)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(t){this.setRotationQuaternion(t)}get scaling(){return this.getScale()}set scaling(t){this.setScale(t)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=M.Zero(),this._localRotation=T.Zero(),this._localPosition=M.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,A.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(t,e=!0,i=!0){this._bindMatrix.copyFrom(t),e&&this._updateAbsoluteBindMatrices(),i?this._matrix=t:this.markAsDirty()}_updateAbsoluteBindMatrices(t,e=!0){if(t||(t=this._bindMatrix),this.parent?t.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(t),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),e)for(let i=0;i<this.children.length;i++)this.children[i]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(t,e=0,i,n=!0){let s=this.getLocalMatrix();if(e==0)n?(s.addAtIndex(12,t.x),s.addAtIndex(13,t.y),s.addAtIndex(14,t.z)):s.setTranslationFromFloats(t.x,t.y,t.z);else{let a=null;i&&(a=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let o=l._TmpMats[0],r=l._TmpVecs[0];this.parent?i&&a?(o.copyFrom(this.parent.getAbsoluteMatrix()),o.multiplyToRef(a,o)):o.copyFrom(this.parent.getAbsoluteMatrix()):A.IdentityToRef(o),n&&o.setTranslationFromFloats(0,0,0),o.invert(),M.TransformCoordinatesToRef(t,o,r),n?(s.addAtIndex(12,r.x),s.addAtIndex(13,r.y),s.addAtIndex(14,r.z)):s.setTranslationFromFloats(r.x,r.y,r.z)}this._markAsDirtyAndDecompose()}translate(t,e=0,i){this._updatePosition(t,e,i,!0)}setPosition(t,e=0,i){this._updatePosition(t,e,i,!1)}setAbsolutePosition(t,e){this.setPosition(t,1,e)}scale(t,e,i,n=!1){let s=this.getLocalMatrix(),a=l._TmpMats[0];A.ScalingToRef(t,e,i,a),a.multiplyToRef(s,s),a.invert();for(let o of this.children){let r=o.getLocalMatrix();r.multiplyToRef(a,r),r.multiplyAtIndex(12,t),r.multiplyAtIndex(13,e),r.multiplyAtIndex(14,i),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),n)for(let o of this.children)o.scale(t,e,i,n)}setScale(t){this._decompose(),this._localScaling.copyFrom(t),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(t){this._decompose(),t.copyFrom(this._localScaling)}setYawPitchRoll(t,e,i,n=0,s){if(n===0){let r=l._TmpQuat;T.RotationYawPitchRollToRef(t,e,i,r),this.setRotationQuaternion(r,n,s);return}let a=l._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(a,s))return;let o=l._TmpMats[1];A.RotationYawPitchRollToRef(t,e,i,o),a.multiplyToRef(o,o),this._rotateWithMatrix(o,n,s)}rotate(t,e,i=0,n){let s=l._TmpMats[0];s.setTranslationFromFloats(0,0,0),A.RotationAxisToRef(t,e,s),this._rotateWithMatrix(s,i,n)}setAxisAngle(t,e,i=0,n){if(i===0){let o=l._TmpQuat;T.RotationAxisToRef(t,e,o),this.setRotationQuaternion(o,i,n);return}let s=l._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,n))return;let a=l._TmpMats[1];A.RotationAxisToRef(t,e,a),s.multiplyToRef(a,a),this._rotateWithMatrix(a,i,n)}setRotation(t,e=0,i){this.setYawPitchRoll(t.y,t.x,t.z,e,i)}setRotationQuaternion(t,e=0,i){if(e===0){this._decompose(),this._localRotation.copyFrom(t),this._markAsDirtyAndCompose();return}let n=l._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,i))return;let s=l._TmpMats[1];A.FromQuaternionToRef(t,s),n.multiplyToRef(s,s),this._rotateWithMatrix(s,e,i)}setRotationMatrix(t,e=0,i){if(e===0){let a=l._TmpQuat;T.FromRotationMatrixToRef(t,a),this.setRotationQuaternion(a,e,i);return}let n=l._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,i))return;let s=l._TmpMats[1];s.copyFrom(t),n.multiplyToRef(t,s),this._rotateWithMatrix(s,e,i)}_rotateWithMatrix(t,e=0,i){let n=this.getLocalMatrix(),s=n.m[12],a=n.m[13],o=n.m[14],r=this.getParent(),h=l._TmpMats[3],m=l._TmpMats[4];r&&e==1?(i?(h.copyFrom(i.getWorldMatrix()),r.getAbsoluteMatrix().multiplyToRef(h,h)):h.copyFrom(r.getAbsoluteMatrix()),m.copyFrom(h),m.invert(),n.multiplyToRef(h,n),n.multiplyToRef(t,n),n.multiplyToRef(m,n)):e==1&&i?(h.copyFrom(i.getWorldMatrix()),m.copyFrom(h),m.invert(),n.multiplyToRef(h,n),n.multiplyToRef(t,n),n.multiplyToRef(m,n)):n.multiplyToRef(t,n),n.setTranslationFromFloats(s,a,o),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(t,e){let i=l._TmpMats[2];return t.copyFrom(this.getAbsoluteMatrix()),e?(t.multiplyToRef(e.getWorldMatrix(),t),A.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,i)):A.IdentityToRef(i),t.invert(),isNaN(t.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),t.multiplyToRef(i,t),!0)}getPosition(t=0,e=null){let i=M.Zero();return this.getPositionToRef(t,e,i),i}getPositionToRef(t=0,e,i){if(t==0){let n=this.getLocalMatrix();i.x=n.m[12],i.y=n.m[13],i.z=n.m[14]}else{let n=null;e&&(n=e.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let s=l._TmpMats[0];e&&n?(s.copyFrom(this.getAbsoluteMatrix()),s.multiplyToRef(n,s)):s=this.getAbsoluteMatrix(),i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}}getAbsolutePosition(t=null){let e=M.Zero();return this.getPositionToRef(1,t,e),e}getAbsolutePositionToRef(t,e){this.getPositionToRef(1,t,e)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);let i=this._skeleton.getPoseMatrix();i&&this._absoluteMatrix.multiplyToRef(i,this._absoluteMatrix)}let t=this.children,e=t.length;for(let i=0;i<e;i++)t[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(t,e=null){let i=M.Zero();return this.getDirectionToRef(t,e,i),i}getDirectionToRef(t,e=null,i){let n=null;e&&(n=e.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let s=l._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),e&&n&&s.multiplyToRef(n,s),M.TransformNormalToRef(t,s,i),i.normalize()}getRotation(t=0,e=null){let i=M.Zero();return this.getRotationToRef(t,e,i),i}getRotationToRef(t=0,e=null,i){let n=l._TmpQuat;this.getRotationQuaternionToRef(t,e,n),n.toEulerAnglesToRef(i)}getRotationQuaternion(t=0,e=null){let i=T.Identity();return this.getRotationQuaternionToRef(t,e,i),i}getRotationQuaternionToRef(t=0,e=null,i){if(t==0)this._decompose(),i.copyFrom(this._localRotation);else{let n=l._TmpMats[0],s=this.getAbsoluteMatrix();e?s.multiplyToRef(e.getWorldMatrix(),n):n.copyFrom(s),n.multiplyAtIndex(0,this._scalingDeterminant),n.multiplyAtIndex(1,this._scalingDeterminant),n.multiplyAtIndex(2,this._scalingDeterminant),n.decompose(void 0,i,void 0)}}getRotationMatrix(t=0,e){let i=A.Identity();return this.getRotationMatrixToRef(t,e,i),i}getRotationMatrixToRef(t=0,e,i){if(t==0)this.getLocalMatrix().getRotationMatrixToRef(i);else{let n=l._TmpMats[0],s=this.getAbsoluteMatrix();e?s.multiplyToRef(e.getWorldMatrix(),n):n.copyFrom(s),n.multiplyAtIndex(0,this._scalingDeterminant),n.multiplyAtIndex(1,this._scalingDeterminant),n.multiplyAtIndex(2,this._scalingDeterminant),n.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(t,e=null){let i=M.Zero();return this.getAbsolutePositionFromLocalToRef(t,e,i),i}getAbsolutePositionFromLocalToRef(t,e=null,i){let n=null;e&&(n=e.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let s=l._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),e&&n&&s.multiplyToRef(n,s),M.TransformCoordinatesToRef(t,s,i)}getLocalPositionFromAbsolute(t,e=null){let i=M.Zero();return this.getLocalPositionFromAbsoluteToRef(t,e,i),i}getLocalPositionFromAbsoluteToRef(t,e=null,i){let n=null;e&&(n=e.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let s=l._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),e&&n&&s.multiplyToRef(n,s),s.invert(),M.TransformCoordinatesToRef(t,s,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}dispose(){this._linkedTransformNode=null;let t=this._skeleton.bones.indexOf(this);if(t!==-1&&this._skeleton.bones.splice(t,1),this._parentNode&&this._parentNode.children){let e=this._parentNode.children,i=e.indexOf(this);i!==-1&&e.splice(i,1)}super.dispose()}};P._TmpVecs=E(2,M.Zero);P._TmpQuat=T.Identity();P._TmpMats=E(5,A.Identity);var L=class{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(t,e,i,n){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._coreRuntimeAnimation=null,this._animation=e,this._target=t,this._scene=i,this._host=n,this._activeTargets=[],e._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===f.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=A.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){let a={frame:0,value:this._minValue};this._keys.splice(0,0,a)}if(this._target instanceof Array){let a=0;for(let o of this._target)this._preparePath(o,a),this._getOriginalValues(a),a++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];let s=e.getEvents();if(s&&s.length>0)for(let a of s)this._events.push(a._clone());this._enableBlending=t&&t.animationPropertiesOverride?t.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(t,e=0){let i=this._animation.targetPropertyPath;if(i.length>1){let n=t;for(let s=0;s<i.length-1;s++){let a=i[s];if(n=n[a],n===void 0)throw new Error(`Invalid property (${a}) in property path (${i.join(".")})`)}this._targetPath=i[i.length-1],this._activeTargets[e]=n}else this._targetPath=i[0],this._activeTargets[e]=t;if(this._activeTargets[e][this._targetPath]===void 0)throw new Error(`Invalid property (${this._targetPath}) in property path (${i.join(".")})`)}get animation(){return this._animation}reset(t=!1){if(t)if(this._target instanceof Array){let e=0;for(let i of this._target)this._originalValue[e]!==void 0&&this._setValue(i,this._activeTargets[e],this._originalValue[e],-1,e),e++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let e=0;e<this._events.length;e++)this._events[e].isDone=!1}isStopped(){return this._stopped}dispose(){let t=this._animation.runtimeAnimations.indexOf(this);t>-1&&this._animation.runtimeAnimations.splice(t,1)}setValue(t,e){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){let n=this._target[i];this._setValue(n,this._activeTargets[i],t,e,i)}return}this._setValue(this._target,this._directTarget,t,e,0)}_getOriginalValues(t=0){let e,i=this._activeTargets[t];i.getLocalMatrix&&this._targetPath==="_matrix"?e=i.getLocalMatrix():e=i[this._targetPath],e&&e.clone?this._originalValue[t]=e.clone():this._originalValue[t]=e}_registerTargetForLateAnimationBinding(t,e){let i=t.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[t.targetPath]||(i._lateAnimationHolders[t.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),t.isAdditive?(i._lateAnimationHolders[t.targetPath].additiveAnimations.push(t),i._lateAnimationHolders[t.targetPath].totalAdditiveWeight+=t.weight):(i._lateAnimationHolders[t.targetPath].animations.push(t),i._lateAnimationHolders[t.targetPath].totalWeight+=t.weight)}_setValue(t,e,i,n,s){if(this._currentActiveTarget=e,this._weight=n,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){let o=e[this._targetPath];o.clone?this._originalBlendValue=o.clone():this._originalBlendValue=o}this._originalBlendValue.m?f.AllowMatrixDecomposeForInterpolation?this._currentValue?A.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=A.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?A.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=A.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=f._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);let a=t&&t.animationPropertiesOverride?t.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=a}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i?.clone?this._currentValue=i.clone():this._currentValue=i;n!==-1?this._registerTargetForLateAnimationBinding(this,this._originalValue[s]):this._animationState.loopMode===f.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[s],e[this._targetPath]):e[this._targetPath]=this._originalValue[s]+this._currentValue:e[this._targetPath]=this._currentValue,t.markAsDirty&&t.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(t,e=-1){let i=this._animation.getKeys();t<i[0].frame?t=i[0].frame:t>i[i.length-1].frame&&(t=i[i.length-1].frame);let n=this._events;if(n.length)for(let a=0;a<n.length;a++)n[a].onlyOnce||(n[a].isDone=n[a].frame<t);this._currentFrame=t;let s=this._animation._interpolate(t,this._animationState);this.setValue(s,e)}_prepareForSpeedRatioChange(t){let e=this._previousElapsedTime*(this._animation.framePerSecond*t)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-e}animate(t,e,i,n,s,a=-1){let o=this._animation,r=o.targetPropertyPath;if(!r||r.length<1)return this._stopped=!0,!1;let h=!0,m,_=this._events,d=0;if(this._coreRuntimeAnimation)d=i-e,m=this._coreRuntimeAnimation.currentFrame,this._currentFrame=m,this._animationState.repeatCount=this._coreRuntimeAnimation._animationState.repeatCount,this._animationState.highLimitValue=this._coreRuntimeAnimation._animationState.highLimitValue,this._animationState.offsetValue=this._coreRuntimeAnimation._animationState.offsetValue;else{(e<this._minFrame||e>this._maxFrame)&&(e=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame),d=i-e;let c,u=t*(o.framePerSecond*s)/1e3+this._absoluteFrameOffset,b=0,F=!1,v=n&&this._animationState.loopMode===f.ANIMATIONLOOPMODE_YOYO;if(v){let p=(u-e)/d,y=Math.sin(p*Math.PI);u=Math.abs(y)*d+e;let w=y>=0?1:-1;this._yoyoDirection!==w&&(F=!0),this._yoyoDirection=w}if(this._previousElapsedTime=t,this._previousAbsoluteFrame=u,!n&&i>=e&&(u>=d&&s>0||u<=0&&s<0))h=!1,b=o._getKeyValue(this._maxValue);else if(!n&&e>=i&&(u<=d&&s<0||u>=0&&s>0))h=!1,b=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==f.ANIMATIONLOOPMODE_CYCLE){let p=i.toString()+e.toString();if(!this._offsetsCache[p]){this._animationState.repeatCount=0,this._animationState.loopMode=f.ANIMATIONLOOPMODE_CYCLE;let y=o._interpolate(e,this._animationState),R=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case f.ANIMATIONTYPE_FLOAT:this._offsetsCache[p]=R-y;break;case f.ANIMATIONTYPE_QUATERNION:this._offsetsCache[p]=R.subtract(y);break;case f.ANIMATIONTYPE_VECTOR3:this._offsetsCache[p]=R.subtract(y);break;case f.ANIMATIONTYPE_VECTOR2:this._offsetsCache[p]=R.subtract(y);break;case f.ANIMATIONTYPE_SIZE:this._offsetsCache[p]=R.subtract(y);break;case f.ANIMATIONTYPE_COLOR3:this._offsetsCache[p]=R.subtract(y);break;default:break}this._highLimitsCache[p]=R}b=this._highLimitsCache[p],c=this._offsetsCache[p]}if(c===void 0)switch(o.dataType){case f.ANIMATIONTYPE_FLOAT:c=0;break;case f.ANIMATIONTYPE_QUATERNION:c=K;break;case f.ANIMATIONTYPE_VECTOR3:c=U;break;case f.ANIMATIONTYPE_VECTOR2:c=z;break;case f.ANIMATIONTYPE_SIZE:c=Y;break;case f.ANIMATIONTYPE_COLOR3:c=H;break;case f.ANIMATIONTYPE_COLOR4:c=q;break}if(this._host&&this._host.syncRoot){let p=this._host.syncRoot,y=(p.masterFrame-p.fromFrame)/(p.toFrame-p.fromFrame);m=e+d*y}else u>0&&e>i||u<0&&e<i?m=h&&d!==0?i+u%d:e:m=h&&d!==0?e+u%d:i;if(!v&&(s>0&&this.currentFrame>m||s<0&&this.currentFrame<m)||v&&F){this._onLoop();for(let p=0;p<_.length;p++)_[p].onlyOnce||(_[p].isDone=!1);this._animationState.key=s>0?0:o.getKeys().length-1}this._currentFrame=m,this._animationState.repeatCount=d===0?0:u/d>>0,this._animationState.highLimitValue=b,this._animationState.offsetValue=c}let g=o._interpolate(m,this._animationState);if(this.setValue(g,a),_.length){for(let c=0;c<_.length;c++)if(d>=0&&m>=_[c].frame&&_[c].frame>=e||d<0&&m<=_[c].frame&&_[c].frame<=e){let u=_[c];u.isDone||(u.onlyOnce&&(_.splice(c,1),c--),u.isDone=!0,u.action(m))}}return h||(this._stopped=!0),h}};var k=class{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(t){if(t===-1){this._weight=-1;return}this._weight=Math.min(Math.max(t,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(t){for(let e=0;e<this._runtimeAnimations.length;e++)this._runtimeAnimations[e]._prepareForSpeedRatioChange(t);this._speedRatio=t,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}get elapsedTime(){return this._localDelayOffset===null?0:this._scene._animationTime-this._localDelayOffset}constructor(t,e,i=0,n=100,s=!1,a=1,o,r,h,m=!1,_=0){this.target=e,this.fromFrame=i,this.toFrame=n,this.loopAnimation=s,this.onAnimationEnd=o,this.onAnimationLoop=h,this.isAdditive=m,this.playOrder=_,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._previousWeight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new O,this.onAnimationLoopObservable=new O,this._scene=t,r&&this.appendAnimations(e,r),this._speedRatio=a,t._activeAnimatables.push(this)}syncWith(t){if(this._syncRoot=t,t){let e=this._scene._activeAnimatables.indexOf(this);e>-1&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(t,e){for(let i=0;i<e.length;i++){let n=e[i],s=new L(t,n,this._scene,this);s._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(s)}}getAnimationByTargetProperty(t){let e=this._runtimeAnimations;for(let i=0;i<e.length;i++)if(e[i].animation.targetProperty===t)return e[i].animation;return null}getRuntimeAnimationByTargetProperty(t){let e=this._runtimeAnimations;for(let i=0;i<e.length;i++)if(e[i].animation.targetProperty===t)return e[i];return null}reset(){let t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(t){let e=this._runtimeAnimations;for(let i=0;i<e.length;i++)e[i].animation.enableBlending=!0,e[i].animation.blendingSpeed=t}disableBlending(){let t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].animation.enableBlending=!1}goToFrame(t,e=!1){let i=this._runtimeAnimations;if(i[0]){let n=i[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??i[0].currentFrame;let s=this.speedRatio===0?0:(t-this._frameToSyncFromJump)/n*1e3/this.speedRatio;this._manualJumpDelay=-s}for(let n=0;n<i.length;n++)i[n].goToFrame(t,e?this._weight:-1);this._goToFrame=t}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(t,e,i=!1,n=!1){if(t||e){let s=this._scene._activeAnimatables.indexOf(this);if(s>-1){let a=this._runtimeAnimations;for(let o=a.length-1;o>=0;o--){let r=a[o];t&&r.animation.name!=t||e&&!e(r.target)||(r.dispose(),a.splice(o,1))}a.length==0&&(i||this._scene._activeAnimatables.splice(s,1),n||this._raiseOnAnimationEnd())}}else{let s=this._scene._activeAnimatables.indexOf(this);if(s>-1){i||this._scene._activeAnimatables.splice(s,1);let a=this._runtimeAnimations;for(let o=0;o<a.length;o++)a[o].dispose();this._runtimeAnimations.length=0,n||this._raiseOnAnimationEnd()}}}waitAsync(){return N(this,null,function*(){return yield new Promise(t=>{this.onAnimationEndObservable.add(()=>{t(this)},void 0,void 0,this,!0)})})}_animate(t){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=t),!0;if(this._localDelayOffset===null?(this._localDelayOffset=t,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=t-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this.speedRatio<0?-this._manualJumpDelay:this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,this._weight===0&&this._previousWeight===0)return!0;this._previousWeight=this._weight;let e=!1,i=this._runtimeAnimations,n;for(n=0;n<i.length;n++){let a=i[n].animate(t-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);e=e||a}if(this.animationStarted=e,!e){if(this.disposeOnEnd)for(n=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(n,1),n=0;n<i.length;n++)i[n].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return e}};function tt(l){if(l.totalWeight===0&&l.totalAdditiveWeight===0)return l.originalValue;let t=1,e=x.Vector3[0],i=x.Vector3[1],n=x.Quaternion[0],s=0,a=l.animations[0],o=l.originalValue,r=1,h=!1;if(l.totalWeight<1)r=1-l.totalWeight,o.decompose(i,n,e);else{if(s=1,t=l.totalWeight,r=a.weight/t,r==1)if(l.totalAdditiveWeight)h=!0;else return a.currentValue;a.currentValue.decompose(i,n,e)}if(!h){i.scaleInPlace(r),e.scaleInPlace(r),n.scaleInPlace(r);for(let _=s;_<l.animations.length;_++){let d=l.animations[_];if(d.weight===0)continue;r=d.weight/t;let g=x.Vector3[2],c=x.Vector3[3],u=x.Quaternion[1];d.currentValue.decompose(c,u,g),c.scaleAndAddToRef(r,i),u.scaleAndAddToRef(T.Dot(n,u)>0?r:-r,n),g.scaleAndAddToRef(r,e)}n.normalize()}for(let _=0;_<l.additiveAnimations.length;_++){let d=l.additiveAnimations[_];if(d.weight===0)continue;let g=x.Vector3[2],c=x.Vector3[3],u=x.Quaternion[1];d.currentValue.decompose(c,u,g),c.multiplyToRef(i,c),M.LerpToRef(i,c,d.weight,i),n.multiplyToRef(u,u),T.SlerpToRef(n,u,d.weight,n),g.scaleAndAddToRef(d.weight,e)}let m=a?a._animationState.workValue:x.Matrix[0].clone();return A.ComposeToRef(i,n,e,m),m}function et(l,t){if(l.totalWeight===0&&l.totalAdditiveWeight===0)return t;let e=l.animations[0],i=l.originalValue,n=t;if(l.totalWeight===0&&l.totalAdditiveWeight>0)n.copyFrom(i);else if(l.animations.length===1){if(T.SlerpToRef(i,e.currentValue,Math.min(1,l.totalWeight),n),l.totalAdditiveWeight===0)return n}else if(l.animations.length>1){let s=1,a,o;if(l.totalWeight<1){let h=1-l.totalWeight;a=[],o=[],a.push(i),o.push(h)}else{if(l.animations.length===2&&(T.SlerpToRef(l.animations[0].currentValue,l.animations[1].currentValue,l.animations[1].weight/l.totalWeight,t),l.totalAdditiveWeight===0))return t;a=[],o=[],s=l.totalWeight}for(let h=0;h<l.animations.length;h++){let m=l.animations[h];a.push(m.currentValue),o.push(m.weight/s)}let r=0;for(let h=0;h<a.length;){if(!h){T.SlerpToRef(a[h],a[h+1],o[h+1]/(o[h]+o[h+1]),t),n=t,r=o[h]+o[h+1],h+=2;continue}r+=o[h],T.SlerpToRef(n,a[h],o[h]/r,n),h++}}for(let s=0;s<l.additiveAnimations.length;s++){let a=l.additiveAnimations[s];a.weight!==0&&(n.multiplyToRef(a.currentValue,x.Quaternion[0]),T.SlerpToRef(n,x.Quaternion[0],a.weight,n))}return n}function it(l){if(l._registeredForLateAnimationBindings.length){for(let t=0;t<l._registeredForLateAnimationBindings.length;t++){let e=l._registeredForLateAnimationBindings.data[t];for(let i in e._lateAnimationHolders){let n=e._lateAnimationHolders[i],s=n.animations[0],a=n.originalValue;if(a==null)continue;let o=f.AllowMatrixDecomposeForInterpolation&&a.m,r=e[i];if(o)r=tt(n);else if(a.w!==void 0)r=et(n,r||T.Identity());else{let m=0,_=1,d=s&&s._animationState.loopMode===f.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(n.totalWeight<1)d?r=a.clone?a.clone():a:s&&a.scale?r=a.scale(1-n.totalWeight):s?r=a*(1-n.totalWeight):a.clone?r=a.clone():r=a;else if(s){_=n.totalWeight;let g=s.weight/_;g!==1?s.currentValue.scale?r=s.currentValue.scale(g):r=s.currentValue*g:r=s.currentValue,d&&(r.addToRef?r.addToRef(a,r):r+=a),m=1}for(let g=m;g<n.animations.length;g++){let c=n.animations[g],u=c.weight/_;if(u)c.currentValue.scaleAndAddToRef?c.currentValue.scaleAndAddToRef(u,r):r+=c.currentValue*u;else continue}for(let g=0;g<n.additiveAnimations.length;g++){let c=n.additiveAnimations[g],u=c.weight;if(u)c.currentValue.scaleAndAddToRef?c.currentValue.scaleAndAddToRef(u,r):r+=c.currentValue*u;else continue}}e[i]=r}e._lateAnimationHolders={}}l._registeredForLateAnimationBindings.reset()}}function $(l,t){t&&(t.prototype.copyAnimationRange=function(e,i,n,s=!1,a=null){this.animations.length===0&&(this.animations.push(new f(this.name,"_matrix",e.animations[0].framePerSecond,f.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));let o=e.animations[0].getRange(i);if(!o)return!1;let r=o.from,h=o.to,m=e.animations[0].getKeys(),_=e.length,d=e.getParent(),g=this.getParent(),c=s&&d&&_&&this.length&&_!==this.length,u=c&&g&&d?g.length/d.length:1,b=s&&!g&&a&&(a.x!==1||a.y!==1||a.z!==1),F=this.animations[0].getKeys(),v,p,y;for(let R=0,w=m.length;R<w;R++)v=m[R],v.frame>=r&&v.frame<=h&&(s?(y=v.value.clone(),c?(p=y.getTranslation(),y.setTranslation(p.scaleInPlace(u))):b&&a?(p=y.getTranslation(),y.setTranslation(p.multiplyInPlace(a))):y=v.value):y=v.value,F.push({frame:v.frame+n,value:y}));return this.animations[0].createRange(i,r+n,h+n),!0}),l&&(l.prototype._animate=function(e){if(!this.animationsEnabled)return;let i=Z.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=i}this.deltaTime=e!==void 0?e:this.useConstantAnimationDeltaTime?16:(i-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=i;let n=this._activeAnimatables;if(n.length===0)return;this._animationTime+=this.deltaTime;let s=this._animationTime;for(let a=0;a<n.length;a++){let o=n[a];!o._animate(s)&&o.disposeOnEnd&&a--}it(this)},l.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((e,i)=>e.playOrder-i.playOrder)},l.prototype.beginWeightedAnimation=function(e,i,n,s=1,a,o=1,r,h,m,_,d=!1){let g=this.beginAnimation(e,i,n,a,o,r,h,!1,m,_,d);return g.weight=s,g},l.prototype.beginAnimation=function(e,i,n,s,a=1,o,r,h=!0,m,_,d=!1){if(a<0){let c=i;i=n,n=c,a=-a}i>n&&(a=-a),h&&this.stopAnimation(e,void 0,m),r||(r=new k(this,e,i,n,s,a,o,void 0,_,d));let g=m?m(e):!0;if(e.animations&&g&&r.appendAnimations(e,e.animations),e.getAnimatables){let c=e.getAnimatables();for(let u=0;u<c.length;u++)this.beginAnimation(c[u],i,n,s,a,o,r,h,m,_)}return r.reset(),r},l.prototype.beginHierarchyAnimation=function(e,i,n,s,a,o=1,r,h,m=!0,_,d,g=!1){let c=e.getDescendants(i),u=[];u.push(this.beginAnimation(e,n,s,a,o,r,h,m,_,void 0,g));for(let b of c)u.push(this.beginAnimation(b,n,s,a,o,r,h,m,_,void 0,g));return u},l.prototype.beginDirectAnimation=function(e,i,n,s,a,o=1,r,h,m=!1){if(o<0){let d=n;n=s,s=d,o=-o}return n>s&&(o=-o),new k(this,e,n,s,a,o,r,i,h,m)},l.prototype.beginDirectHierarchyAnimation=function(e,i,n,s,a,o,r,h,m,_=!1){let d=e.getDescendants(i),g=[];g.push(this.beginDirectAnimation(e,n,s,a,o,r,h,m,_));for(let c of d)g.push(this.beginDirectAnimation(c,n,s,a,o,r,h,m,_));return g},l.prototype.getAnimatableByTarget=function(e){for(let i=0;i<this._activeAnimatables.length;i++)if(this._activeAnimatables[i].target===e)return this._activeAnimatables[i];return null},l.prototype.getAllAnimatablesByTarget=function(e){let i=[];for(let n=0;n<this._activeAnimatables.length;n++)this._activeAnimatables[n].target===e&&i.push(this._activeAnimatables[n]);return i},l.prototype.stopAnimation=function(e,i,n){let s=this.getAllAnimatablesByTarget(e);for(let a of s)a.stop(i,n)},l.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(let e of this.animationGroups)e.stop()})}$(X,P);var B=class{getClassName(){return"TargetedAnimation"}serialize(){let t={};return t.animation=this.animation.serialize(),t.targetId=this.target.id,t}},D=class l{get mask(){return this._mask}set mask(t){this._mask!==t&&(this._mask=t,this.syncWithMask(!0))}syncWithMask(t=!1){if(!this.mask&&!t){this._numActiveAnimatables=this._targetedAnimations.length;return}this._numActiveAnimatables=0;for(let e=0;e<this._animatables.length;++e){let i=this._animatables[e];!this.mask||this.mask.disabled||this.mask.retainsTarget(i.target.name)?(this._numActiveAnimatables++,i.paused&&i.restart()):i.paused||i.pause()}}removeUnmaskedAnimations(){if(!(!this.mask||this.mask.disabled)){for(let t=0;t<this._animatables.length;++t){let e=this._animatables[t];this.mask.retainsTarget(e.target.name)||(e.stop(),this._animatables.splice(t,1),--t)}for(let t=0;t<this._targetedAnimations.length;t++){let e=this._targetedAnimations[t];this.mask.retainsTarget(e.target.name)||(this._targetedAnimations.splice(t,1),--t)}}}get from(){return this._from}set from(t){if(this._from!==t){this._from=t;for(let e=0;e<this._animatables.length;e++){let i=this._animatables[e];i.fromFrame=this._from}}}get to(){return this._to}set to(t){if(this._to!==t){this._to=t;for(let e=0;e<this._animatables.length;e++){let i=this._animatables[e];i.toFrame=this._to}}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(t){if(this._speedRatio!==t){this._speedRatio=t;for(let e=0;e<this._animatables.length;e++){let i=this._animatables[e];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(t){if(this._loopAnimation!==t){this._loopAnimation=t;for(let e=0;e<this._animatables.length;e++){let i=this._animatables[e];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(t){if(this._isAdditive!==t){this._isAdditive=t;for(let e=0;e<this._animatables.length;e++){let i=this._animatables[e];i.isAdditive=this._isAdditive}}}get weight(){return this._weight}set weight(t){this._weight!==t&&(this._weight=t,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(t){if(this._playOrder!==t&&(this._playOrder=t,this._animatables.length>0)){for(let e=0;e<this._animatables.length;e++)this._animatables[e].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(t){if(this._enableBlending!==t&&(this._enableBlending=t,t!==null))for(let e=0;e<this._targetedAnimations.length;++e)this._targetedAnimations[e].animation.enableBlending=t}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(t){if(this._blendingSpeed!==t&&(this._blendingSpeed=t,t!==null))for(let e=0;e<this._targetedAnimations.length;++e)this._targetedAnimations[e].animation.blendingSpeed=t}getLength(t,e){t=t??this._from,e=e??this._to;let i=this.targetedAnimations[0].animation.framePerSecond*this._speedRatio;return(e-t)/i}static MergeAnimationGroups(t,e=!0,i=!1,n){if(t.length===0)return null;n=n??t[0].weight;let s=Number.MAX_VALUE,a=-Number.MAX_VALUE;if(i)for(let r of t)r.from<s&&(s=r.from),r.to>a&&(a=r.to);let o=new l(t[0].name+"_merged",t[0]._scene,n);for(let r of t){i&&r.normalize(s,a);for(let h of r.targetedAnimations)o.addTargetedAnimation(h.animation,h.target);e&&r.dispose()}return o}constructor(t,e=null,i=-1,n=0){this.name=t,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._shouldStart=!0,this._parentContainer=null,this.onAnimationEndObservable=new O,this.onAnimationLoopObservable=new O,this.onAnimationGroupLoopObservable=new O,this.onAnimationGroupEndObservable=new O,this.onAnimationGroupPauseObservable=new O,this.onAnimationGroupPlayObservable=new O,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=e||G.LastCreatedScene,this._weight=i,this._playOrder=n,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(t,e){let i=new B;i.animation=t,i.target=e;let n=t.getKeys();return this._from>n[0].frame&&(this._from=n[0].frame),this._to<n[n.length-1].frame&&(this._to=n[n.length-1].frame),this._enableBlending!==null&&(t.enableBlending=this._enableBlending),this._blendingSpeed!==null&&(t.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),this._shouldStart=!0,i}removeTargetedAnimation(t){for(let e=this._targetedAnimations.length-1;e>-1;e--)this._targetedAnimations[e].animation===t&&this._targetedAnimations.splice(e,1)}normalize(t=null,e=null){t==null&&(t=this._from),e==null&&(e=this._to);for(let i=0;i<this._targetedAnimations.length;i++){let s=this._targetedAnimations[i].animation.getKeys(),a=s[0],o=s[s.length-1];if(a.frame>t){let r={frame:t,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation};s.splice(0,0,r)}if(o.frame<e){let r={frame:e,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};s.push(r)}}return this._from=t,this._to=e,this}_processLoop(t,e,i){t.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(e),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(t=!1,e=1,i,n,s){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=t,this._shouldStart=!1,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let a=0;a<this._targetedAnimations.length;a++){let o=this._targetedAnimations[a],r=this._scene.beginDirectAnimation(o.target,[o.animation],i!==void 0?i:this._from,n!==void 0?n:this._to,t,e,void 0,void 0,s!==void 0?s:this._isAdditive);r.weight=this._weight,r.playOrder=this._playOrder,r.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(r)},this._processLoop(r,o,a),this._animatables.push(r)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=e,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let t=0;t<this._animatables.length;t++)this._animatables[t].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(t){return this.isStarted&&this._animatables.length&&!this._shouldStart?(t!==void 0&&(this.loopAnimation=t),this.restart()):(this.stop(),this.start(t,this._speedRatio)),this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(!0),this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].reset();return this}restart(){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].restart();return this.syncWithMask(),this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(t=!1){if(!this._isStarted)return this;let e=this._animatables.slice();for(let n=0;n<e.length;n++)e[n].stop(void 0,void 0,!0,t);let i=0;for(let n=0;n<this._scene._activeAnimatables.length;n++){let s=this._scene._activeAnimatables[n];s._runtimeAnimations.length>0?this._scene._activeAnimatables[i++]=s:t&&this._checkAnimationGroupEnded(s,t)}return this._scene._activeAnimatables.length=i,this._isStarted=!1,this}setWeightForAllAnimatables(t){for(let e=0;e<this._animatables.length;e++){let i=this._animatables[e];i.weight=t}return this}syncAllAnimationsWith(t){for(let e=0;e<this._animatables.length;e++)this._animatables[e].syncWith(t);return this}goToFrame(t,e=!1){if(!this._isStarted)return this;for(let i=0;i<this._animatables.length;i++)this._animatables[i].goToFrame(t,e);return this}getCurrentFrame(){return this.animatables[0]?.masterFrame||0}dispose(){this.isStarted&&this.stop(),this._targetedAnimations.length=0,this._animatables.length=0;let t=this._scene.animationGroups.indexOf(this);if(t>-1&&this._scene.animationGroups.splice(t,1),this._parentContainer){let e=this._parentContainer.animationGroups.indexOf(this);e>-1&&this._parentContainer.animationGroups.splice(e,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(t,e=!1){let i=this._animatables.indexOf(t);i>-1&&this._animatables.splice(i,1),this._animatables.length===this._targetedAnimations.length-this._numActiveAnimatables&&(this._isStarted=!1,e||this.onAnimationGroupEndObservable.notifyObservers(this),this._animatables.length=0)}clone(t,e,i=!1){let n=new l(t||this.name,this._scene,this._weight,this._playOrder);n._from=this.from,n._to=this.to,n._speedRatio=this.speedRatio,n._loopAnimation=this.loopAnimation,n._isAdditive=this.isAdditive,n._enableBlending=this.enableBlending,n._blendingSpeed=this.blendingSpeed,n.metadata=this.metadata,n.mask=this.mask;for(let s of this._targetedAnimations)n.addTargetedAnimation(i?s.animation.clone():s.animation,e?e(s.target):s.target);return n}serialize(){let t={};t.name=this.name,t.from=this.from,t.to=this.to,t.speedRatio=this.speedRatio,t.loopAnimation=this.loopAnimation,t.isAdditive=this.isAdditive,t.weight=this.weight,t.playOrder=this.playOrder,t.enableBlending=this.enableBlending,t.blendingSpeed=this.blendingSpeed,t.targetedAnimations=[];for(let e=0;e<this.targetedAnimations.length;e++){let i=this.targetedAnimations[e];t.targetedAnimations[e]=i.serialize()}return V&&V.HasTags(this)&&(t.tags=V.GetTags(this)),this.metadata&&(t.metadata=this.metadata),t}static Parse(t,e){let i=new l(t.name,e,t.weight,t.playOrder);for(let n=0;n<t.targetedAnimations.length;n++){let s=t.targetedAnimations[n],a=f.Parse(s.animation),o=s.targetId;if(s.animation.property==="influence"){let r=e.getMorphTargetById(o);r&&i.addTargetedAnimation(a,r)}else{let r=e.getNodeById(o);r!=null&&i.addTargetedAnimation(a,r)}}return V&&V.AddTagsTo(i,t.tags),t.from!==null&&t.to!==null&&i.normalize(t.from,t.to),t.speedRatio!==void 0&&(i._speedRatio=t.speedRatio),t.loopAnimation!==void 0&&(i._loopAnimation=t.loopAnimation),t.isAdditive!==void 0&&(i._isAdditive=t.isAdditive),t.weight!==void 0&&(i._weight=t.weight),t.playOrder!==void 0&&(i._playOrder=t.playOrder),t.enableBlending!==void 0&&(i._enableBlending=t.enableBlending),t.blendingSpeed!==void 0&&(i._blendingSpeed=t.blendingSpeed),t.metadata!==void 0&&(i.metadata=t.metadata),i}static MakeAnimationAdditive(t,e,i,n=!1,s){let a;typeof e=="object"?a=e:a={referenceFrame:e,range:i,cloneOriginalAnimationGroup:n,clonedAnimationName:s};let o=t;a.cloneOriginalAnimationGroup&&(o=t.clone(a.clonedAnimationGroupName||o.name));let r=o.targetedAnimations;for(let h=0;h<r.length;h++){let m=r[h];m.animation=f.MakeAnimationAdditive(m.animation,a)}if(o.isAdditive=!0,a.clipKeys){let h=Number.MAX_VALUE,m=-Number.MAX_VALUE,_=o.targetedAnimations;for(let d=0;d<_.length;d++){let u=_[d].animation.getKeys();h>u[0].frame&&(h=u[0].frame),m<u[u.length-1].frame&&(m=u[u.length-1].frame)}o._from=h,o._to=m}return o}static ClipKeys(t,e,i,n,s){let a=t.clone(n||t.name);return l.ClipKeysInPlace(a,e,i,s)}static ClipKeysInPlace(t,e,i,n){return l.ClipInPlace(t,e,i,n,!1)}static ClipFrames(t,e,i,n,s){let a=t.clone(n||t.name);return l.ClipFramesInPlace(a,e,i,s)}static ClipFramesInPlace(t,e,i,n){return l.ClipInPlace(t,e,i,n,!0)}static ClipInPlace(t,e,i,n,s=!1){let a=Number.MAX_VALUE,o=-Number.MAX_VALUE,r=t.targetedAnimations;for(let h=0;h<r.length;h++){let m=r[h],_=n?m.animation:m.animation.clone();s&&(_.createKeyForFrame(e),_.createKeyForFrame(i));let d=_.getKeys(),g=[],c=Number.MAX_VALUE;for(let u=0;u<d.length;u++){let b=d[u];if(!s&&u>=e&&u<=i||s&&b.frame>=e&&b.frame<=i){let F={frame:b.frame,value:b.value.clone?b.value.clone():b.value,inTangent:b.inTangent,outTangent:b.outTangent,interpolation:b.interpolation,lockedTangent:b.lockedTangent};c===Number.MAX_VALUE&&(c=F.frame),F.frame-=c,g.push(F)}}if(g.length===0){r.splice(h,1),h--;continue}a>g[0].frame&&(a=g[0].frame),o<g[g.length-1].frame&&(o=g[g.length-1].frame),_.setKeys(g,!0),m.animation=_}return t._from=a,t._to=o,t}getClassName(){return"AnimationGroup"}toString(t){let e="Name: "+this.name;return e+=", type: "+this.getClassName(),t&&(e+=", from: "+this._from,e+=", to: "+this._to,e+=", isStarted: "+this._isStarted,e+=", speedRatio: "+this._speedRatio,e+=", targetedAnimations length: "+this._targetedAnimations.length,e+=", animatables length: "+this._animatables),e}};var C=class extends j{constructor(t){super(t,["animationLoop","animationEnd","animationGroupLoop"]),this.config=t,this.speed=this.registerDataInput("speed",I),this.loop=this.registerDataInput("loop",J),this.from=this.registerDataInput("from",I,0),this.to=this.registerDataInput("to",I),this.currentFrame=this.registerDataOutput("currentFrame",I),this.currentTime=this.registerDataOutput("currentTime",I),this.currentAnimationGroup=this.registerDataOutput("currentAnimationGroup",S),this.animationGroup=this.registerDataInput("animationGroup",S,t?.animationGroup),this.animation=this.registerDataInput("animation",S),this.object=this.registerDataInput("object",S)}_preparePendingTasks(t){let e=this.animationGroup.getValue(t),i=this.animation.getValue(t);if(!e&&!i)return this._reportError(t,"No animation or animation group provided");{let n=this.currentAnimationGroup.getValue(t);n&&n!==e&&n.dispose();let s=e;if(i&&!s){let _=this.object.getValue(t);if(!_)return this._reportError(t,"No target object provided");let d=Array.isArray(i)?i:[i],g=d[0].name;s=new D("flowGraphAnimationGroup-"+g+"-"+_.name,t.configuration.scene);let c=!1,u=t._getGlobalContextVariable("interpolationAnimations",[]);for(let b of d)s.addTargetedAnimation(b,_),u.indexOf(b.uniqueId)!==-1&&(c=!0);c&&this._checkInterpolationDuplications(t,d,_)}let a=this.speed.getValue(t)||1,o=this.from.getValue(t)??0,r=this.to.getValue(t)||s.to,h=!isFinite(r)||this.loop.getValue(t);this.currentAnimationGroup.setValue(s,t);let m=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);m.indexOf(s.uniqueId)!==-1&&s.stop();try{s.start(h,a,o,r),s.onAnimationGroupEndObservable.add(()=>this._onAnimationGroupEnd(t)),s.onAnimationEndObservable.add(()=>this._eventsSignalOutputs.animationEnd._activateSignal(t)),s.onAnimationLoopObservable.add(()=>this._eventsSignalOutputs.animationLoop._activateSignal(t)),s.onAnimationGroupLoopObservable.add(()=>this._eventsSignalOutputs.animationGroupLoop._activateSignal(t)),m.push(s.uniqueId),t._setGlobalContextVariable("currentlyRunningAnimationGroups",m)}catch(_){this._reportError(t,_)}}}_reportError(t,e){super._reportError(t,e),this.currentFrame.setValue(-1,t),this.currentTime.setValue(-1,t)}_executeOnTick(t){let e=this.currentAnimationGroup.getValue(t);e&&(this.currentFrame.setValue(e.getCurrentFrame(),t),this.currentTime.setValue(e.animatables[0]?.elapsedTime??0,t))}_execute(t){this._startPendingTasks(t)}_onAnimationGroupEnd(t){this._removeFromCurrentlyRunning(t,this.currentAnimationGroup.getValue(t)),this._resetAfterCanceled(t),this.done._activateSignal(t)}_checkInterpolationDuplications(t,e,i){let n=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(let s of n){let a=t.assetsContext.animationGroups.find(o=>o.uniqueId===s);if(a)for(let o of a.targetedAnimations)for(let r of e)o.animation.targetProperty===r.targetProperty&&o.target===i&&this._stopAnimationGroup(t,a)}}_stopAnimationGroup(t,e){e.stop(!0),e.dispose(),this._removeFromCurrentlyRunning(t,e)}_removeFromCurrentlyRunning(t,e){let i=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),n=i.indexOf(e.uniqueId);n!==-1&&(i.splice(n,1),t._setGlobalContextVariable("currentlyRunningAnimationGroups",i))}_cancelPendingTasks(t){let e=this.currentAnimationGroup.getValue(t);e&&this._stopAnimationGroup(t,e)}getClassName(){return"FlowGraphPlayAnimationBlock"}};W("FlowGraphPlayAnimationBlock",C);export{P as a,D as b,C as c};
