import{c as _,d as R,g as F}from"./chunk-H3MFDEMG.js";import{h as s,j as c,k as O}from"./chunk-RMITEGV7.js";import{e as w}from"./chunk-CWQQB2EJ.js";import{i as P,j as p}from"./chunk-RLBU4MYZ.js";var o={coneInnerAngle:6.28318530718,coneOuterAngle:6.28318530718,coneOuterVolume:0,distanceModel:"linear",maxDistance:1e4,minDistance:1,panningModel:"equalpower",position:s.Zero(),rolloffFactor:1,rotation:s.Zero(),rotationQuaternion:new c};function T(e){return e.spatialEnabled||e.spatialAutoUpdate!==void 0||e.spatialConeInnerAngle!==void 0||e.spatialConeOuterAngle!==void 0||e.spatialConeOuterVolume!==void 0||e.spatialDistanceModel!==void 0||e.spatialMaxDistance!==void 0||e.spatialMinDistance!==void 0||e.spatialMinUpdateTime!==void 0||e.spatialPanningModel!==void 0||e.spatialPosition!==void 0||e.spatialRolloffFactor!==void 0||e.spatialRotation!==void 0||e.spatialRotationQuaternion!==void 0}var m=class{};var g={pan:0};function G(e){return e.stereoEnabled||e.stereoPan!==void 0}var f=class{};var A=class extends _{constructor(t){super("Stereo",t)}setOptions(t){this.pan=t.stereoPan??g.pan}};function M(e){return e.getSubNode("Stereo")}function I(e,t,n){e.callOnSubNode("Stereo",i=>{i[t]=n})}var V=class extends f{constructor(t){super(),this._pan=g.pan,this._subGraph=t}get pan(){return this._pan}set pan(t){this._pan=t,I(this._subGraph,"pan",t)}};var N=class{constructor(t){this._attachmentType=3,this._position=new s,this._rotationQuaternion=new c,this._sceneNode=null,this._useBoundingBox=!1,this.dispose=()=>{this.detach()},this._spatialAudioNode=t}get isAttached(){return this._sceneNode!==null}attach(t,n,i){this._sceneNode!==t&&(this.detach(),t&&(this._attachmentType=i,this._sceneNode=t,this._sceneNode.onDisposeObservable.add(this.dispose),this._useBoundingBox=n))}detach(){this._sceneNode?.onDisposeObservable.removeCallback(this.dispose),this._sceneNode=null}update(){this._attachmentType&1&&(this._useBoundingBox&&this._sceneNode.getBoundingInfo?this._position.copyFrom(this._sceneNode.getBoundingInfo().boundingBox.centerWorld):this._sceneNode?.getWorldMatrix().getTranslationToRef(this._position),this._spatialAudioNode.position.copyFrom(this._position),this._spatialAudioNode._updatePosition()),this._attachmentType&2&&(this._sceneNode?.getWorldMatrix().decompose(void 0,this._rotationQuaternion),this._spatialAudioNode.rotationQuaternion.copyFrom(this._rotationQuaternion),this._spatialAudioNode._updateRotation())}};var x=class extends _{constructor(t){super("Spatial",t),this._attacherComponent=null}get isAttached(){return this._attacherComponent!==null&&this._attacherComponent.isAttached}attach(t,n,i){this.detach(),this._attacherComponent||(this._attacherComponent=new N(this)),this._attacherComponent.attach(t,n,i)}detach(){this._attacherComponent?.detach()}dispose(){super.dispose(),this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(t){this.coneInnerAngle=t.spatialConeInnerAngle??o.coneInnerAngle,this.coneOuterAngle=t.spatialConeOuterAngle??o.coneOuterAngle,this.coneOuterVolume=t.spatialConeOuterVolume??o.coneOuterVolume,this.distanceModel=t.spatialDistanceModel??o.distanceModel,this.maxDistance=t.spatialMaxDistance??o.maxDistance,this.minDistance=t.spatialMinDistance??o.minDistance,this.panningModel=t.spatialPanningModel??o.panningModel,this.rolloffFactor=t.spatialRolloffFactor??o.rolloffFactor,t.spatialPosition&&(this.position=t.spatialPosition.clone()),t.spatialRotationQuaternion?this.rotationQuaternion=t.spatialRotationQuaternion.clone():t.spatialRotation?this.rotation=t.spatialRotation.clone():this.rotationQuaternion=o.rotationQuaternion.clone(),this.update()}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}};function a(e){return e.getSubNode("Spatial")}function u(e,t,n){e.callOnSubNode("Spatial",i=>{i[t]=n})}var U=O.Zero(),y=new c,S=s.Zero();function E(e){return e*Math.PI/180}function W(e){return e*180/Math.PI}function q(e){return p(this,null,function*(){return new C(e)})}var C=class extends x{constructor(t){super(t),this._lastPosition=s.Zero(),this._lastRotation=s.Zero(),this._lastRotationQuaternion=new c,this.position=o.position.clone(),this.rotation=o.rotation.clone(),this.rotationQuaternion=o.rotationQuaternion.clone(),this.node=new PannerNode(t._audioContext)}get coneInnerAngle(){return E(this.node.coneInnerAngle)}set coneInnerAngle(t){this.node.coneInnerAngle=W(t)}get coneOuterAngle(){return E(this.node.coneOuterAngle)}set coneOuterAngle(t){this.node.coneOuterAngle=W(t)}get coneOuterVolume(){return this.node.coneOuterGain}set coneOuterVolume(t){this.node.coneOuterGain=t}get distanceModel(){return this.node.distanceModel}set distanceModel(t){this.node.distanceModel=t;let n=this.node.maxDistance;this.node.maxDistance=n+.001,this.node.maxDistance=n}get minDistance(){return this.node.refDistance}set minDistance(t){this.node.refDistance=t}get maxDistance(){return this.node.maxDistance}set maxDistance(t){this.node.maxDistance=t}get panningModel(){return this.node.panningModel}set panningModel(t){this.node.panningModel=t}get rolloffFactor(){return this.node.rolloffFactor}set rolloffFactor(t){this.node.rolloffFactor=t}get _inNode(){return this.node}get _outNode(){return this.node}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||(this.engine._setAudioParam(this.node.positionX,this.position.x),this.engine._setAudioParam(this.node.positionY,this.position.y),this.engine._setAudioParam(this.node.positionZ,this.position.z),this._lastPosition.copyFrom(this.position))}_updateRotation(){if(!this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))y.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);else if(!this._lastRotation.equalsWithEpsilon(this.rotation))c.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,y),this._lastRotation.copyFrom(this.rotation);else return;O.FromQuaternionToRef(y,U),s.TransformNormalToRef(s.RightReadOnly,U,S),this.engine._setAudioParam(this.node.orientationX,S.x),this.engine._setAudioParam(this.node.orientationY,S.y),this.engine._setAudioParam(this.node.orientationZ,S.z)}_connect(t){return super._connect(t)?(t._inNode&&this.node.connect(t._inNode),!0):!1}_disconnect(t){return super._disconnect(t)?(t._inNode&&this.node.disconnect(t._inNode),!0):!1}getClassName(){return"_SpatialWebAudioSubNode"}};function B(e){return p(this,null,function*(){return new Q(e)})}var Q=class extends A{constructor(t){super(t),this._pan=0,this.node=new StereoPannerNode(t._audioContext)}get pan(){return this._pan}set pan(t){this._pan=t,this.engine._setAudioParam(this.node.pan,t)}get _inNode(){return this.node}get _outNode(){return this.node}getClassName(){return"_StereoWebAudioSubNode"}_connect(t){return super._connect(t)?(t._inNode&&this.node.connect(t._inNode),!0):!1}_disconnect(t){return super._disconnect(t)?(t._inNode&&this.node.disconnect(t._inNode),!0):!1}};var Z=class e extends F{constructor(){super(...arguments),this._rootNode=null,this._inputNode=null}initAsync(t){return p(this,null,function*(){yield P(e.prototype,this,"initAsync").call(this,t);let n=!1,i=!1;(n=T(t))&&(yield this.createAndAddSubNodeAsync("Spatial")),(i=G(t))&&(yield this.createAndAddSubNodeAsync("Stereo")),yield this._createSubNodePromisesResolvedAsync(),n&&a(this)?.setOptions(t),i&&M(this)?.setOptions(t)})}get _inNode(){return this._inputNode}_createSubNode(t){try{return super._createSubNode(t)}catch{}switch(t){case"Spatial":return q(this._owner.engine);case"Stereo":return B(this._owner.engine);default:throw new Error(`Unknown subnode name: ${t}`)}}_onSubNodesChanged(){super._onSubNodesChanged();let t=a(this),n=M(this),i=R(this);if(t&&t.getClassName()!=="_SpatialWebAudioSubNode")throw new Error("Not a WebAudio subnode.");if(n&&n.getClassName()!=="_StereoWebAudioSubNode")throw new Error("Not a WebAudio subnode.");if(i&&i.getClassName()!=="_VolumeWebAudioSubNode")throw new Error("Not a WebAudio subnode.");t&&(t.disconnectAll(),i&&t.connect(i)),n&&(n.disconnectAll(),i&&n.connect(i)),t&&n?(this._rootNode=new GainNode(this._owner.engine._audioContext),this._rootNode.connect(t._outNode),this._rootNode.connect(n._outNode)):(this._rootNode?.disconnect(),this._rootNode=null);let h=null,r=null;if(this._rootNode?r=this._rootNode:(t?h=t:n?h=n:i&&(h=i),r=h?.node??null),this._inputNode!==r){if(this._inputNode&&this._upstreamNodes){let d=this._upstreamNodes.values();for(let l=d.next();!l.done;l=d.next())l.value._outNode?.disconnect(this._inputNode)}if(this._inputNode=r,r&&this._upstreamNodes){let d=this._upstreamNodes.values();for(let l=d.next();!l.done;l=d.next())l.value._outNode?.connect(r)}}}};var b=class extends m{constructor(t){super(),this._coneInnerAngle=o.coneInnerAngle,this._coneOuterAngle=o.coneOuterAngle,this._coneOuterVolume=o.coneOuterVolume,this._distanceModel=o.distanceModel,this._maxDistance=o.maxDistance,this._minDistance=o.minDistance,this._panningModel=o.panningModel,this._rolloffFactor=o.rolloffFactor;let n=a(t);n?(this._position=n.position.clone(),this._rotation=n.rotation.clone(),this._rotationQuaternion=n.rotationQuaternion.clone()):(this._position=o.position.clone(),this._rotation=o.rotation.clone(),this._rotationQuaternion=o.rotationQuaternion.clone(),t.createAndAddSubNodeAsync("Spatial")),this._subGraph=t}get coneInnerAngle(){return this._coneInnerAngle}set coneInnerAngle(t){this._coneInnerAngle=t,u(this._subGraph,"coneInnerAngle",t)}get coneOuterAngle(){return this._coneOuterAngle}set coneOuterAngle(t){this._coneOuterAngle=t,u(this._subGraph,"coneOuterAngle",t)}get coneOuterVolume(){return this._coneOuterVolume}set coneOuterVolume(t){this._coneOuterVolume=t,u(this._subGraph,"coneOuterVolume",t)}get distanceModel(){return this._distanceModel}set distanceModel(t){this._distanceModel=t,u(this._subGraph,"distanceModel",t)}get isAttached(){return this._subGraph.getSubNode("Spatial")?.isAttached??!1}get maxDistance(){return this._maxDistance}set maxDistance(t){t<=0&&(t=1e-6),this._maxDistance=t,u(this._subGraph,"maxDistance",t)}get minDistance(){return this._minDistance}set minDistance(t){this._minDistance=t,u(this._subGraph,"minDistance",t)}get panningModel(){return this._panningModel}set panningModel(t){this._panningModel=t,u(this._subGraph,"panningModel",t)}get position(){return this._position}set position(t){this._position=t,this._updatePosition()}get rolloffFactor(){return this._rolloffFactor}set rolloffFactor(t){this._rolloffFactor=t,u(this._subGraph,"rolloffFactor",t)}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._updateRotation()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(t){this._rotationQuaternion=t,this._updateRotation()}attach(t,n=!1,i=3){a(this._subGraph)?.attach(t,n,i)}detach(){a(this._subGraph)?.detach()}update(){let t=a(this._subGraph);t&&(t.isAttached?t.update():(this._updatePosition(t),this._updateRotation(t)))}_updatePosition(t=null){if(!t&&(t=a(this._subGraph),!t))return;t.position.equalsWithEpsilon(this._position)||(t.position.copyFrom(this._position),t._updatePosition())}_updateRotation(t=null){!t&&(t=a(this._subGraph),!t)||(t.rotationQuaternion.equalsWithEpsilon(this._rotationQuaternion)?t.rotation.equalsWithEpsilon(this._rotation)||(t.rotation.copyFrom(this._rotation),t._updateRotation()):(t.rotationQuaternion.copyFrom(this._rotationQuaternion),t._updateRotation()))}};var D=class{constructor(t,n,i){if(this._autoUpdate=!0,this._lastUpdateTime=0,this.minUpdateTime=0,!n)return;this.minUpdateTime=i;let h=()=>{if(!this._autoUpdate)return;let r=!1;if(0<this.minUpdateTime){let d=w.Now;this._lastUpdateTime&&d-this._lastUpdateTime<this.minUpdateTime&&(r=!0),this._lastUpdateTime=d}r||t.update(),requestAnimationFrame(h)};requestAnimationFrame(h)}dispose(){this._autoUpdate=!1}};var H=class extends b{constructor(t,n,i){super(t),this._updaterComponent=new D(this,n,i)}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(t){this._updaterComponent.minUpdateTime=t}dispose(){this._updaterComponent.dispose(),this._updaterComponent=null}};export{T as a,V as b,Z as c,H as d};
