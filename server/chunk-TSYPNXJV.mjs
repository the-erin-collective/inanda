import './polyfills.server.mjs';
import{a as f,b as g,c as y,d as b}from"./chunk-TZ4YY3SZ.mjs";import{a as l,b as c,c as p,d as m}from"./chunk-KYE5IJFB.mjs";import{k as a}from"./chunk-H4UZCO6D.mjs";var r=class extends f{constructor(t,e){super(t,e)}get duration(){return this._options.duration}set duration(t){this._options.duration=t}get loopStart(){return this._options.loopStart}set loopStart(t){this._options.loopStart=t}get loopEnd(){return this._options.loopEnd}set loopEnd(t){this._options.loopEnd=t}get pitch(){return this._options.pitch}set pitch(t){this._options.pitch=t;let e=this._instances.values();for(let i=e.next();!i.done;i=e.next())i.value.pitch=t}get playbackRate(){return this._options.playbackRate}set playbackRate(t){this._options.playbackRate=t;let e=this._instances.values();for(let i=e.next();!i.done;i=e.next())i.value.playbackRate=t}play(t={}){if(this.state===5){this.resume();return}t.duration??(t.duration=this.duration),t.loop??(t.loop=this.loop),t.loopStart??(t.loopStart=this.loopStart),t.loopEnd??(t.loopEnd=this.loopEnd),t.startOffset??(t.startOffset=this.startOffset),t.volume??(t.volume=1),t.waitTime??(t.waitTime=0);let e=this._createInstance();this._beforePlay(e),e.play(t),this._afterPlay(e),this._stopExcessInstances()}stop(t={}){if(t.waitTime&&0<t.waitTime?this._setState(0):this._setState(1),!!this._instances)for(let e of Array.from(this._instances))e.stop(t)}};var S=1,u=class{constructor(t){this.name=`StaticSoundBuffer #${S++}`,this.engine=t}};var h=class extends g{};var N=(()=>{class n extends r{constructor(e,i,s){super(e,i),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof s.spatialAutoUpdate=="boolean"&&(this._spatialAutoUpdate=s.spatialAutoUpdate),typeof s.spatialMinUpdateTime=="number"&&(this._spatialMinUpdateTime=s.spatialMinUpdateTime),this._options={autoplay:s.autoplay??!1,duration:s.duration??0,loop:s.loop??!1,loopEnd:s.loopEnd??0,loopStart:s.loopStart??0,maxInstances:s.maxInstances??1/0,pitch:s.pitch??0,playbackRate:s.playbackRate??1,startOffset:s.startOffset??0},this._subGraph=new n._SubGraph(this)}_initAsync(e,i){return a(this,null,function*(){this._audioContext=this.engine._audioContext,e instanceof d?this._buffer=e:(typeof e=="string"||Array.isArray(e)||e instanceof ArrayBuffer||e instanceof AudioBuffer)&&(this._buffer=yield this.engine.createSoundBufferAsync(e,i)),i.outBus?this.outBus=i.outBus:i.outBusAutoDefault!==!1&&(yield this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),yield this._subGraph.initAsync(i),l(i)&&this._initSpatialProperty(),i.autoplay&&this.play(),this.engine._addNode(this)})}get buffer(){return this._buffer}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new c(this._subGraph))}cloneAsync(e=null){return a(this,null,function*(){let i=yield this.engine.createSoundAsync(this.name,e?.cloneBuffer?this.buffer.clone():this.buffer,this._options);return i.outBus=e?.outBus?e.outBus:this.outBus,i})}dispose(){super.dispose(),this._spatial?.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return"_WebAudioStaticSound"}_createInstance(){return new _(this,this._options)}_connect(e){return super._connect(e)?(e._inNode&&this._outNode?.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this._outNode?.disconnect(e._inNode),!0):!1}_initSpatialProperty(){return this._spatial||(this._spatial=new m(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}}return n._SubGraph=class extends p{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}},n})(),d=class n extends u{constructor(t){super(t)}_initAsync(t,e){return a(this,null,function*(){t instanceof AudioBuffer?this._audioBuffer=t:typeof t=="string"?yield this._initFromUrlAsync(t):Array.isArray(t)?yield this._initFromUrlsAsync(t,e.skipCodecCheck??!1):t instanceof ArrayBuffer&&(yield this._initFromArrayBufferAsync(t))})}get channelCount(){return this._audioBuffer.numberOfChannels}get duration(){return this._audioBuffer.duration}get length(){return this._audioBuffer.length}get sampleRate(){return this._audioBuffer.sampleRate}clone(t=null){let e=new AudioBuffer({length:this._audioBuffer.length,numberOfChannels:this._audioBuffer.numberOfChannels,sampleRate:this._audioBuffer.sampleRate});for(let s=0;s<this._audioBuffer.numberOfChannels;s++)e.copyToChannel(this._audioBuffer.getChannelData(s),s);let i=new n(this.engine);return i._audioBuffer=e,i.name=t?.name?t.name:this.name,i}_initFromArrayBufferAsync(t){return a(this,null,function*(){this._audioBuffer=yield this.engine._audioContext.decodeAudioData(t)})}_initFromUrlAsync(t){return a(this,null,function*(){t=b(t),yield this._initFromArrayBufferAsync(yield(yield fetch(t)).arrayBuffer())})}_initFromUrlsAsync(t,e){return a(this,null,function*(){for(let i of t){if(e)yield this._initFromUrlAsync(i);else{let o=i.match(y)?.at(1);if(o&&this.engine.isFormatValid(o))try{yield this._initFromUrlAsync(i)}catch{o&&0<o.length&&this.engine.flagInvalidFormat(o)}}if(this._audioBuffer)break}})}},_=class extends h{constructor(t,e){super(t),this._enginePlayTime=0,this._enginePauseTime=0,this._sourceNode=null,this._onEnded=()=>{this._enginePlayTime=0,this.onEndedObservable.notifyObservers(this),this._deinitSourceNode()},this._onEngineStateChanged=()=>{this.engine.state==="running"&&(this._options.loop&&this.state===2&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._options=e,this._volumeNode=new GainNode(t._audioContext),this._initSourceNode()}get currentTime(){if(this._state===1)return 0;let t=this._state===5?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+t+this._options.startOffset}set currentTime(t){let e=this._state===2||this._state===3;e&&(this.stop(),this._deinitSourceNode()),this._options.startOffset=t,e&&this.play()}get _outNode(){return this._volumeNode}set pitch(t){this._sourceNode&&this.engine._setAudioParam(this._sourceNode.detune,t)}set playbackRate(t){this._sourceNode&&this.engine._setAudioParam(this._sourceNode.playbackRate,t)}get startTime(){return this._state===1?0:this._enginePlayTime}dispose(){super.dispose(),this._sourceNode=null,this.stop(),this._deinitSourceNode(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}getClassName(){return"_WebAudioStaticSoundInstance"}play(t={}){if(this._state===3)return;t.duration!==void 0&&(this._options.duration=t.duration),t.loop!==void 0&&(this._options.loop=t.loop),t.loopStart!==void 0&&(this._options.loopStart=t.loopStart),t.loopEnd!==void 0&&(this._options.loopEnd=t.loopEnd),t.startOffset!==void 0&&(this._options.startOffset=t.startOffset);let e=this._options.startOffset;this._state===5&&(e+=this.currentTime,e%=this._sound.buffer.duration),this._enginePlayTime=this.engine.currentTime+(t.waitTime??0),this._volumeNode.gain.value=t.volume??1,this._initSourceNode(),this.engine.state==="running"?(this._setState(3),this._sourceNode?.start(this._enginePlayTime,e,this._options.duration>0?this._options.duration:void 0)):this._options.loop&&(this._setState(2),this.engine.stateChangedObservable.add(this._onEngineStateChanged))}pause(){this._state!==5&&(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._sourceNode?.stop(),this._deinitSourceNode())}resume(){this._state===5&&this.play()}stop(t={}){if(this._state===1)return;this._setState(1);let e=this.engine.currentTime+(t.waitTime??0);this._sourceNode?.stop(e),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}_connect(t){return super._connect(t)?(t instanceof N&&t._inNode&&this._outNode?.connect(t._inNode),!0):!1}_disconnect(t){return super._disconnect(t)?(t instanceof N&&t._inNode&&this._outNode?.disconnect(t._inNode),!0):!1}_deinitSourceNode(){if(this._sourceNode){if(!this._disconnect(this._sound))throw new Error("Disconnect failed");this._sourceNode.disconnect(this._volumeNode),this._sourceNode.removeEventListener("ended",this._onEnded),this._sourceNode=null}}_initSourceNode(){if(!this._sourceNode&&(this._sourceNode=new AudioBufferSourceNode(this._sound._audioContext,{buffer:this._sound.buffer._audioBuffer}),this._sourceNode.addEventListener("ended",this._onEnded,{once:!0}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound)))throw new Error("Connect failed");let t=this._sourceNode;t.detune.value=this._sound.pitch,t.loop=this._options.loop,t.loopEnd=this._options.loopEnd,t.loopStart=this._options.loopStart,t.playbackRate.value=this._sound.playbackRate}};export{N as a,d as b};
